#!/bin/bash

set -eu

trap "echo Exited!; exit 1;" SIGINT SIGTERM

PROJECT_DIR="$(cd "$(dirname "$0")/.."; pwd)"
cd $PROJECT_DIR

tmp_dir=`mktemp -d`
trap "rm -r $tmp_dir" EXIT

# standalone LogCache consumes from Loggregator. Replace it with CF.
cat <<EOF > $tmp_dir/consumes_cf.yml
- type: replace
  path: /instance_groups/name=log-cache/jobs/name=log-cache-nozzle/consumes/reverse_log_proxy/deployment?
  value: cf
EOF

# standalone LogCache does not register any routes via the route_registrar
cat <<EOF >> $tmp_dir/consumes_cf.yml
- type: replace
  path: /instance_groups/name=log-cache/jobs/-
  value:
    name: route_registrar
    release: routing
    properties:
      route_registrar:
        routes:
        - name: log-cache
          port: 8081
          registration_interval: 20s
          uris:
          - log-cache.((system_domain))
          - "*.log-cache.((system_domain))"
EOF

bosh int manifests/log-cache.yml --ops-file=$tmp_dir/consumes_cf.yml > $tmp_dir/adjusted.yml

ops_file_path=manifests/operations/deploy-in-cf.yml

# save the instance_groups
instance_groups=`bosh int $tmp_dir/adjusted.yml --path /instance_groups | sed 's/^\-/ /' | sed 's/^/  /'`

# save the variables
variables=`bosh int $tmp_dir/adjusted.yml --path /variables | sed 's/^\-/ /' | sed 's/^/  /'`

# write instance_groups and variables to new ops-file
cat <<EOF > manifests/operations/deploy-in-cf.yml
# NOTE: This is generated code
# The following operations file has been generated by the
# scripts/generate_deploy_in_cf_ops script.
# It is generated from the standalone manifest (manifests/log-cache.yml) and
# altered to fit into the CF-Deployment manifest.

- type: replace
  path: /releases/-
  value:
    name: log-cache
    version: latest
- type: replace
  path: /instance_groups/-
  value:
$instance_groups
- type: replace
  path: /variables/-
  value:
$variables
EOF
