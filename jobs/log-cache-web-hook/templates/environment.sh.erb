# Log Cache
<%
    l = link('log-cache-group-reader')
    lc_addr = "#{l.address}:#{l.p('port')}"
%>
export LOG_CACHE_ADDR="<%= lc_addr %>"

tmpdir=/var/vcap/jobs/log-cache-web-hook/txt_templates
rm -rf $tmpdir
mkdir $tmpdir

<%=
    require 'securerandom'
    i = 0
    templates = Array.new
    follow_templates = Array.new
    output = Array.new
    if_p('queries') do
        p('queries').each do | query |
            i=i+1
            random_string = "EOF_"+SecureRandom.hex
            (query["follow"] ? follow_templates : templates).push("#{query["source_ids"].join(";")}=$tmpdir/#{i}")
            output.push("cat << #{random_string} > $tmpdir/#{i}")
            output.push("#{query["query"]}")
            output.push("#{random_string}")
        end
    end

    output.join("\n")
%>

chmod -R a+r $tmpdir

export TEMPLATE_PATHS="<%= templates.join(",") %>"
export FOLLOW_TEMPLATE_PATHS="<%= follow_templates.join(",") %>"
export GROUP_PREFIX="log-cache-web-hook"

# TLS
export CA_PATH="/var/vcap/jobs/log-cache-web-hook/config/certs/ca.crt"
export CERT_PATH="/var/vcap/jobs/log-cache-web-hook/config/certs/log_cache.crt"
export KEY_PATH="/var/vcap/jobs/log-cache-web-hook/config/certs/log_cache.key"
